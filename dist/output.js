// Build: 2023/6/6 12:26:48 Author: Maasea
(()=>{var d=class{constructor(t,e,s){this._times=new Map,this.name=t??"",this.debug=s?.debug??!1,t&&this.log(`${t} Start`),this.className=e??"",this.init()}static getInstance(t,e){let s=typeof $task<"u"?"QuanX":"Surge";return d.instances[s]||(d.instances[s]=d.classNames[s](t,s,e)),d.instances[s]}createProxy(t){return new Proxy(t,{get:this.getFn,set:this.setFn})}getFn(t,e,s){return t[e]}setFn(t,e,s,r){return t[e]=s,!0}getJSON(t,e={}){let s=this.getVal(t);return s?JSON.parse(s):e}setJSON(t,e){this.setVal(JSON.stringify(t),e)}msg(t=this.name,e="",s="",r){}log(t){this.debug&&(typeof t=="object"&&(t=JSON.stringify(t)),console.log(t))}timeStart(t){this._times.set(t,Date.now())}timeEnd(t){if(this._times?.has(t)){let e=Date.now()-this._times.get(t);this.log(`${t}: ${e}ms`),this._times.delete(t)}else this.log(`Timer with label ${t} does not exist.`)}exit(){$done({})}reject(){$done()}},y=d;y.instances={},y.classNames={QuanX:(t,e,s)=>new b(t,e,s),Surge:(t,e,s)=>new g(t,e,s)};var u=class extends y{getFn(t,e,s){let r=u.clientAdapter[e]||e;return super.getFn(t,r,s)}setFn(t,e,s,r){let n=u.clientAdapter[e]||e;return super.setFn(t,n,s,r)}init(){try{this.request=this.createProxy($request),this.response=this.createProxy($response)}catch(t){this.log(t.toString())}}getVal(t){return $persistentStore.read(t)}setVal(t,e){$persistentStore.write(t,e)}msg(t=this.name,e="",s="",r){$notification.post(t,e,s,{url:r??""})}async fetch(t){return await new Promise((e,s)=>{let{method:r,body:n,bodyBytes:o,...a}=t,c=o??n,f=c instanceof Uint8Array;$httpClient[r.toLowerCase()]({...a,body:c,"binary-mode":f},(h,p,w)=>{h&&s(h);let A=f?"bodyBytes":"body";e({status:p.status,headers:p.headers,[A]:w})})})}done(t){let e=t.response??t,s,r;e.bodyBytes?(s=e.bodyBytes,delete e.bodyBytes,r={...t},r.response?r.response.body=s:r.body=s):r=t,$done(r)}},g=u;g.clientAdapter={bodyBytes:"body"};var i=class extends y{static transferBodyBytes(t,e){return t instanceof ArrayBuffer?e==="Uint8Array"?new Uint8Array(t):t:t instanceof Uint8Array&&e==="ArrayBuffer"?t.buffer.slice(t.byteOffset,t.byteLength+t.byteOffset):t}init(){try{this.request=this.createProxy($request),this.response=this.createProxy($response)}catch(t){this.log(t.toString())}}getFn(t,e,s){let r=i.clientAdapter[e]||e,n=super.getFn(t,r,s);return e==="bodyBytes"&&(n=i.transferBodyBytes(n,"Uint8Array")),n}setFn(t,e,s,r){let n=i.clientAdapter[e]||e,o=s;return e==="bodyBytes"&&(o=i.transferBodyBytes(o,"Uint8Array")),super.setFn(t,n,o,r)}getVal(t){return $prefs.valueForKey(t)?.replace(/\0/g,"")}setVal(t,e){$prefs.setValueForKey(t,e)}msg(t=this.name,e="",s="",r){$notify(t,e,s,{"open-url":r??""})}async fetch(t){return await new Promise(e=>{let s={url:"",method:"GET"};for(let[r,n]of Object.entries(t))r==="id"?s.sessionIndex=n:r==="bodyBytes"?s.bodyBytes=i.transferBodyBytes(n,"ArrayBuffer"):s[r]=n;t.bodyBytes&&delete s.body,$task.fetch(s).then(r=>{let n={status:200,headers:{}};for(let[o,a]of Object.entries(r))o==="sessionIndex"?n.id=a:o==="bodyBytes"?n.bodyBytes=i.transferBodyBytes(a,"Uint8Array"):o==="statusCode"?n.status=a:n[o]=a;e(n)})})}done(t){let e=t.response??t,s={};for(let[r,n]of Object.entries(e))r==="status"?s.status=`HTTP/1.1 ${n}`:r==="bodyBytes"?s.bodyBytes=i.transferBodyBytes(n,"ArrayBuffer"):s[r]=n;$done(s)}},b=i;b.clientAdapter={id:"sessionIndex",status:"statusCode"};function B(t){return typeof t=="string"?JSON.parse(t):t}function m(t){return typeof t=="object"?JSON.stringify(t):t}var l=y.getInstance("Script Name",{debug:!0}),$=B(l.response.body);$.foo="123456";l.timeStart("Loop");for(let t=0;t<1e4;t++);l.timeEnd("Loop");l.msg("a","b","c","https://www.baidu.com");l.done({body:m($)});})();
